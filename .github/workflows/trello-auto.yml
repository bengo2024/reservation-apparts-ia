name: Trello Auto-Checklist

on:
  push:
    branches: [ main ]

jobs:
  update-checklist:
    runs-on: ubuntu-latest
    steps:
      - name: Extraire ID carte et sous-tâche
        id: extract
        run: |
          MSG="${{ github.event.head_commit.message }}"
          CARD=$(echo "$MSG" | grep -oE '\[TRELLO-[A-Za-z0-9]{8,}\]' | tr -d '[]' | cut -d- -f2)
          ITEM=$(echo "$MSG" | grep -oP 'Coche \K.+(?=$)')
          echo "card_id=$CARD" >> $GITHUB_OUTPUT
          echo "item_name=$ITEM" >> $GITHUB_OUTPUT

      - name: Récupérer ID checklist et item
        if: steps.extract.outputs.card_id != '' && steps.extract.outputs.item_name != ''
        id: get-ids
        run: |
          CHECKLIST_ID=$(curl "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/checklists" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" -d "token=${{ secrets.TRELLO_TOKEN }}" | jq -r '[ .[] | .id ] | first')
          ITEM_ID=$(curl "https://api.trello.com/1/checklists/$CHECKLIST_ID/checkItems" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" -d "token=${{ secrets.TRELLO_TOKEN }}" | jq -r '.[] | select(.name=="${{ steps.extract.outputs.item_name }}") | .id')
          echo "checklist_id=$CHECKLIST_ID" >> $GITHUB_OUTPUT
          echo "item_id=$ITEM_ID" >> $GITHUB_OUTPUT

      - name: Cocher la sous-tâche
        if: steps.get-ids.outputs.item_id != ''
        run: |
          curl -X PUT "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/checkItem/${{ steps.get-ids.outputs.item_id }}" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" -d "token=${{ secrets.TRELLO_TOKEN }}" -d "state=complete"

      - name: Ajouter commentaire
        if: steps.extract.outputs.card_id != ''
        run: |
          curl -X POST "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/actions/comments" \
            -d "key=${{ secrets.TRELLO_API_KEY }}" -d "token=${{ secrets.TRELLO_TOKEN }}" \
            -d "text=Commit par @${{ github.actor }}%0A${{ github.event.head_commit.message }}%0ALien : ${{ github.event.head_commit.url }}"
