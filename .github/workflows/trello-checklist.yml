name: Trello – Cocher sous-tâche existante

on:
  push:
    branches: [ main ]

jobs:
  trello:
    runs-on: ubuntu-latest
    steps:
      - name: Extraire ID carte et nom exact
        id: parse
        run: |
          MSG="${{ github.event.head_commit.message }}"
          CARD=$(echo "$MSG" | grep -oP '\[TRELLO-\K[A-Za-z0-9]+')
          ITEM=$(echo "$MSG" | grep -oP 'Coche \K.*')
          echo "CARD_ID=$CARD" >> $GITHUB_OUTPUT
          echo "ITEM_NAME=$ITEM" >> $GITHUB_OUTPUT
          echo "Commit message: $MSG"

      - name: Cocher une sous-tâche EXISTANTE
        if: steps.parse.outputs.CARD_ID != '' && steps.parse.outputs.ITEM_NAME != ''
        env:
          KEY: ${{ secrets.TRELLO_API_KEY }}
          TOKEN: ${{ secrets.TRELLO_TOKEN }}
        run: |
          CARD="${{ steps.parse.outputs.CARD_ID }}"
          ITEM="${{ steps.parse.outputs.ITEM_NAME }}"

          # Récupère la première checklist
          CHECKLIST_ID=$(curl -s "https://api.trello.com/1/cards/$CARD/checklists?key=$KEY&token=$TOKEN" | jq -r '.[0].id')

          # Trouve l’ID de l’item EXISTANT avec le bon nom
          ITEM_ID=$(curl -s "https://api.trello.com/1/checklists/$CHECKLIST_ID/checkItems?key=$KEY&token=$TOKEN" | \
                    jq -r --arg name "$ITEM" '.[] | select(.name == $name) | .id')

          if [[ -n "$ITEM_ID" && "$ITEM_ID" != "null" ]]; then
            echo "Coche l'item existant : $ITEM"
            curl -X PUT "https://api.trello.com/1/cards/$CARD/checkItem/$ITEM_ID \
              -d "key=$KEY" -d "token=$TOKEN" -d "state=complete"
          else
            echo "Item '$ITEM' non trouvé → rien à cocher"
          fi
